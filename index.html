<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P2Pforyou â€” Sell USDT</title>
  <meta name="description" content="Sell USDT â€” fast P2P orders. Select network, payment mode and submit order to merchant." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1: #04101a;
      --bg-2: #071827;
      --panel: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --muted: #9fb0bf;
      --glass: rgba(255,255,255,0.03);
      --accent-1: #00ff88;
      --accent-2: #33ffd4;
      --glass-border: rgba(255,255,255,0.04);
      --radius: 14px;
      --card-radius: 12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(0,255,136,0.02), transparent 5%),
                  radial-gradient(900px 500px at 95% 92%, rgba(255,255,255,0.01), transparent 8%),
                  linear-gradient(135deg,var(--bg-1),var(--bg-2));
      color: #e8f7f0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* container */
    .app { width:100%; max-width:760px; display:flex; gap:20px; align-items:flex-start; justify-content:center; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding:20px;
      box-shadow: 0 10px 40px rgba(3,8,20,0.6);
      width:100%;
      overflow:hidden;
    }

    /* header */
    .top { display:flex; gap:14px; align-items:center; }
    .brand {
      display:inline-flex; align-items:center; gap:10px;
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      color:#001; font-weight:800; padding:8px 12px; border-radius:10px; letter-spacing:0.6px;
    }
    .title { display:flex; flex-direction:column; }
    h1 { margin:0; font-size:18px; line-height:1; }
    .lead { margin-top:6px; color:var(--muted); font-size:13px; }

    /* layout: left (form) and right (rates) */
    .layout { display:grid; grid-template-columns: 1fr 320px; gap:18px; margin-top:16px; align-items:start; }
    @media (max-width:980px){ .layout { grid-template-columns: 1fr; } }

    /* Rates card */
    .rates {
      background: linear-gradient(180deg, rgba(255,255,255,0.014), transparent);
      border-radius: var(--card-radius);
      padding:12px;
      border:1px solid rgba(255,255,255,0.02);
    }
    .rates h3 { margin:0 0 8px 0; font-size:15px; }
    .rate-list { display:grid; gap:10px; grid-template-columns:1fr; }
    .rate-item {
      padding:10px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(255,255,255,0.02);
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .rate-item:hover { transform:translateY(-4px); box-shadow:0 8px 30px rgba(2,8,23,0.45); }
    .rate-range { color:var(--muted); font-size:13px; }
    .rate-value { font-weight:800; color:var(--accent-1); font-size:15px; }

    /* form */
    form { display:grid; gap:12px; margin-top:6px; }
    label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    .input, select, textarea {
      width:100%; padding:12px 14px; border-radius:10px; background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.04); color:inherit; font-size:14px; outline:none;
      transition: box-shadow .12s ease, transform .08s ease;
    }
    .input:focus, select:focus { box-shadow: 0 8px 20px rgba(0,255,136,0.06); transform:translateY(-1px); border-color: rgba(0,255,136,0.12); }
    .row { display:flex; gap:10px; }
    .half { flex:1; }

    .address-box { display:flex; gap:8px; align-items:center; }
    .address-box input { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; letter-spacing:0.6px; }
    .copy-btn {
      padding:10px 12px; border-radius:10px; background: rgba(255,255,255,0.03); border:none; cursor:pointer;
      transition: background .12s ease;
    }
    .copy-btn:hover { background: rgba(255,255,255,0.05); }

    .small { font-size:12px; color:var(--muted); }
    .info-row { display:flex; justify-content:space-between; align-items:center; gap:8px; }

    .actions { display:flex; gap:10px; margin-top:6px; }
    .btn {
      flex:1; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; cursor:pointer;
    }
    .btn.primary {
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:#001; border:none; font-weight:700;
      transition: transform .08s ease;
    }
    .btn.primary:active { transform:translateY(1px); }

    /* helper / warnings */
    .help { font-size:13px; color:var(--muted); }
    .error { color:#ff7b88; font-weight:700; font-size:13px; }

    /* watermark style */
    .watermark { position:fixed; right:18px; bottom:18px; opacity:0.035; font-weight:900; font-size:140px; transform:rotate(-12deg); pointer-events:none; user-select:none; }

    /* animations */
    .fadeIn { animation:fadeIn .22s ease both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to{ opacity:1; transform:none;} }
    .micro { transition: all .12s ease; }

    /* responsive tweaks */
    @media (max-width:520px){
      body { padding:14px; }
      .brand { padding:6px 10px; }
      .rates { order: -1; margin-bottom:10px; }
      .watermark { display:none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel fadeIn" role="main" aria-labelledby="pageTitle">
      <div class="top">
        <div class="brand">P2Pforyou</div>
        <div class="title">
          <h1 id="pageTitle">Sell USDT</h1>
          <div class="lead">Fast P2P â€” choose network, payment mode and submit. No admin details are shown on frontend.</div>
        </div>
      </div>

      <div class="layout">
        <!-- left: form -->
        <div>
          <form id="orderForm" enctype="multipart/form-data" autocomplete="off" novalidate>
            <!-- network -->
            <label for="network">Network</label>
            <select id="network" name="network" class="input" required>
              <option value="BEP20">USDT BEP20</option>
              <option value="Polygon">USDT Polygon</option>
              <option value="TRC20">USDT TRC20</option>
            </select>

            <!-- amount -->
            <label for="usdt">USDT Amount</label>
            <input id="usdt" name="usdt_amount" class="input" type="number" inputmode="decimal" min="1.2" max="500" step="0.01" placeholder="Minimum varies by payment mode" required />

            <div class="info-row">
              <div class="help">Rate: <span id="rateDisplay">â€”</span></div>
              <div class="help">You get: <strong id="inrDisplay">â€”</strong></div>
            </div>

            <!-- address -->
            <label>Send USDT to</label>
            <div class="address-box">
              <input id="usdt_address" name="usdt_address" class="input" type="text" readonly value="0x1A63d865D881E15D4103a5c031a67C0d63e9849C" />
              <button type="button" id="copyAddressBtn" class="copy-btn" aria-label="Copy USDT address">ðŸ“‹</button>
            </div>
            <div class="small">Address updates by network. Copy to wallet when sending.</div>

            <!-- payment mode -->
            <label for="payment_mode">Payment Receiving Mode</label>
            <select id="payment_mode" name="payment_mode" class="input" required>
              <option value="">-- Select Payment Mode --</option>
              <option value="UPI">UPI</option>
              <option value="CDM">CDM (Cash Deposit Machine)</option>
              <option value="Bank">Bank Transfer</option>
            </select>

            <!-- dynamic fields -->
            <div id="modeFields" class="micro"></div>

            <!-- min/max note -->
            <div class="help" id="minNote">Minimum order: <strong id="minValue">1.2</strong> USDT Â· Maximum: <strong>500</strong> USDT</div>

            <!-- actions -->
            <div class="actions">
              <button type="button" id="previewBtn" class="btn">Preview</button>
              <button type="submit" id="submitBtn" class="btn primary">Submit Order</button>
            </div>

            <div style="margin-top:10px" class="small">Support â€¢ Live chat (coming soon)</div>
            <div id="formError" style="margin-top:10px;"></div>
          </form>
        </div>

        <!-- right: rates column -->
        <aside class="rates" aria-hidden="false">
          <h3>USDT â†’ INR Rates</h3>
          <div class="rate-list">
            <div class="rate-item">
              <div class="rate-range">1.2 â€“ 10 USDT</div>
              <div class="rate-value">â‚¹83.50</div>
            </div>
            <div class="rate-item">
              <div class="rate-range">10.01 â€“ 30.99 USDT</div>
              <div class="rate-value">â‚¹84.00</div>
            </div>
            <div class="rate-item">
              <div class="rate-range">30.99 â€“ 100.99 USDT</div>
              <div class="rate-value">â‚¹85.20</div>
            </div>
            <div class="rate-item">
              <div class="rate-range">100.99 â€“ 380.90 USDT</div>
              <div class="rate-value">â‚¹86.00</div>
            </div>
            <div class="rate-item">
              <div class="rate-range">380.90 â€“ 500 USDT</div>
              <div class="rate-value">â‚¹86.60</div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div class="watermark">P2Pforyou</div>

  <script>
    // === KEEP YOUR BACKEND URL EXACTLY AS-IS ===
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxuTvGuI7VGakfHIXOip8yDy261HUo4ycW0FPqJNo1nVTteLAEbavONXtbAPEvKbXWE/exec';

    // Elements
    const networkEl = document.getElementById('network');
    const usdtEl = document.getElementById('usdt');
    const rateEl = document.getElementById('rateDisplay');
    const inrEl = document.getElementById('inrDisplay');
    const addressEl = document.getElementById('usdt_address');
    const paymentModeEl = document.getElementById('payment_mode');
    const modeFields = document.getElementById('modeFields');
    const copyBtn = document.getElementById('copyAddressBtn');
    const submitBtn = document.getElementById('submitBtn');
    const previewBtn = document.getElementById('previewBtn');
    const form = document.getElementById('orderForm');
    const minNoteEl = document.getElementById('minNote');
    const minValueEl = document.getElementById('minValue');
    const formError = document.getElementById('formError');

    // Address mapping (kept same addresses)
    const addresses = {
      BEP20: '0x1A63d865D881E15D4103a5c031a67C0d63e9849C',
      Polygon: '0x1A63d865D881E15D4103a5c031a67C0d63e9849C',
      TRC20: 'TUYMmZN5oTfyjDZ8zqbqsfepdbvBgoBDz3'
    };

    // Rate function (unchanged)
    function getRate(amount){
      if(amount >= 1.2 && amount <= 10) return 83.5;
      if(amount > 10 && amount <= 30.99) return 84;
      if(amount > 30.99 && amount <= 100.99) return 85.2;
      if(amount > 100.99 && amount <= 380.9) return 86;
      if(amount > 380.9 && amount <= 500) return 86.6;
      return 0;
    }

    // Minimum rules per payment mode:
    // CDM => min 50
    // UPI & Bank => min 1.2
    const MIN_DEFAULT = 1.2;
    const MIN_CDM = 50;

    // update address on network change
    function updateAddress(){
      addressEl.value = addresses[networkEl.value] || addresses.BEP20;
    }
    networkEl.addEventListener('change', updateAddress);
    updateAddress();

    // copy address with fallback
    copyBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(addressEl.value);
        copyBtn.textContent = 'Copied';
        setTimeout(()=>copyBtn.textContent='ðŸ“‹',1200);
      }catch(e){
        addressEl.select();
        document.execCommand('copy');
        copyBtn.textContent = 'Copied';
        setTimeout(()=>copyBtn.textContent='ðŸ“‹',1200);
      }
    });

    // render payment-mode dependent fields and set min rule
    function renderModeFields(){
      const mode = paymentModeEl.value;
      modeFields.innerHTML = '';
      // set min enforced on the input
      let minAllowed = MIN_DEFAULT;
      if(mode === 'UPI'){
        minAllowed = MIN_DEFAULT;
        modeFields.innerHTML = `
          <label>UPI ID</label>
          <input name="upi_id" class="input" placeholder="yourupi@bank" />
          <label>Upload Scanner (PNG only)</label>
          <input name="scanner" class="input" type="file" accept="image/png" />
          <div class="small">PNG only. Recommended size &lt; 3MB.</div>
        `;
      } else if(mode === 'CDM'){
        minAllowed = MIN_CDM;
        modeFields.innerHTML = `
          <label>Account Number</label>
          <input name="cdm_account_number" class="input" />
          <label>Bank Name</label>
          <input name="cdm_bank_name" class="input" />
          <label>Account Holder</label>
          <input name="cdm_holder_name" class="input" />
          <div class="small">CDM orders start from <strong>50 USDT</strong>.</div>
        `;
      } else if(mode === 'Bank'){
        minAllowed = MIN_DEFAULT;
        modeFields.innerHTML = `
          <label>Account Number</label>
          <input name="bank_account_number" class="input" />
          <label>Bank Name</label>
          <input name="bank_name" class="input" />
          <label>Account Holder</label>
          <input name="bank_holder_name" class="input" />
          <label>IFSC</label>
          <input name="ifsc_code" class="input" />
        `;
      }

      // enforce min attribute; also update helper text
      if(minAllowed){
        usdtEl.min = minAllowed;
        minValueEl.textContent = Number(minAllowed).toFixed(2).replace(/\.00$/, '');
      } else {
        usdtEl.min = MIN_DEFAULT;
        minValueEl.textContent = MIN_DEFAULT;
      }

      // update placeholder and run validation display
      usdtEl.placeholder = `Min ${usdtEl.min} Â· Max 500`;
      updateRateDisplay();
    }
    paymentModeEl.addEventListener('change', renderModeFields);

    // update rate & INR display
    function updateRateDisplay(){
      const v = parseFloat(usdtEl.value);
      const mode = paymentModeEl.value;
      let minAllowed = (mode === 'CDM') ? MIN_CDM : MIN_DEFAULT;

      if (isNaN(v) || v === 0){
        rateEl.textContent = 'â€”';
        inrEl.textContent = 'â€”';
        formError.innerHTML = '';
        return;
      }

      // cap maximum
      if(v > 500){
        usdtEl.value = 500; // enforce cap
        // keep v as 500
      }

      // check minimum
      if(v < minAllowed){
        rateEl.textContent = 'â€”';
        inrEl.textContent = 'â€”';
        formError.innerHTML = `<div class="error">Minimum for ${mode || 'selected mode'} is ${minAllowed} USDT.</div>`;
        return;
      } else {
        formError.innerHTML = '';
      }

      const rate = getRate(v);
      if(rate === 0){
        rateEl.textContent = 'Invalid amount';
        inrEl.textContent = 'â€”';
      } else {
        rateEl.textContent = 'â‚¹' + rate.toFixed(2);
        inrEl.textContent = 'â‚¹' + (v * rate).toFixed(2);
      }
    }
    usdtEl.addEventListener('input', updateRateDisplay);

    // preview button
    previewBtn.addEventListener('click', ()=>{
      const amount = usdtEl.value.trim();
      const net = networkEl.value;
      const addr = addressEl.value;
      const mode = paymentModeEl.value;
      if(!amount || !mode) return alert('Enter amount and select payment mode to preview.');
      // validate min rules before preview
      const minAllowed = (mode === 'CDM') ? MIN_CDM : MIN_DEFAULT;
      const amt = parseFloat(amount);
      if(isNaN(amt) || amt < minAllowed){
        return alert(`Minimum for ${mode} is ${minAllowed} USDT.`);
      }
      const rate = getRate(amt) || 0;
      const inr = (amt * rate).toFixed(2);
      const msg = `Confirm order:\nNetwork: ${net}\nAmount: ${amt} USDT\nYou will receive: â‚¹${inr}\nSend to: ${addr}`;
      if(confirm(msg)) form.requestSubmit();
    });

    // form submit with validation and scanner checks (PNG only)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.innerHTML = '';
      const mode = paymentModeEl.value;
      if(!mode) { formError.innerHTML = '<div class="error">Please select a payment receiving mode.</div>'; return; }

      // validate amount
      const amt = parseFloat(usdtEl.value);
      const minAllowed = (mode === 'CDM') ? MIN_CDM : MIN_DEFAULT;
      if(isNaN(amt) || amt < minAllowed){
        formError.innerHTML = `<div class="error">Minimum for ${mode} is ${minAllowed} USDT.</div>`;
        return;
      }
      if(amt > 500){
        formError.innerHTML = '<div class="error">Maximum allowed is 500 USDT.</div>';
        return;
      }

      // scanner validation (if present)
      const scannerInput = form.querySelector('input[name="scanner"]');
      if(scannerInput && scannerInput.files.length){
        const f = scannerInput.files[0];
        if(f.type !== 'image/png' && !f.name.toLowerCase().endsWith('.png')){
          formError.innerHTML = '<div class="error">Scanner file must be a PNG image.</div>';
          return;
        }
        if(f.size > 4 * 1024 * 1024){
          if(!confirm('Scanner file > 4MB. Continue?')) return;
        }
      }

      // submit state
      const orig = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const fd = new FormData(form);
        fd.append('client_ts', new Date().toISOString());
        const res = await fetch(scriptURL, { method: 'POST', body: fd });
        const txt = await res.text();

        // attempt to parse order id similarly to your existing logic
        let orderId = null;
        try{
          const j = JSON.parse(txt);
          orderId = j.orderId || j.order_id || j.id || j.OrderID || null;
        }catch(_){}
        if(!orderId){
          const m = txt.match(/[A-Za-z0-9_-]{6,}/);
          if(m) orderId = m[0];
        }
        if(!orderId){
          const cleaned = txt.trim();
          if(cleaned && cleaned.length < 200) orderId = cleaned;
        }

        if(orderId){
          // redirect to waiting page (unchanged behavior)
          window.location.href = `waiting.html?orderId=${encodeURIComponent(orderId)}`;
        } else {
          alert('Order created but the returned Order ID could not be detected. Response:\n' + (txt.substring(0,200)));
          submitBtn.disabled = false; submitBtn.textContent = orig;
        }
      } catch (err) {
        console.error('Submit failed', err);
        alert('Submission failed â€” please try again.');
        submitBtn.disabled = false; submitBtn.textContent = orig;
      }
    });

    // small UX on load
    document.addEventListener('DOMContentLoaded', () => {
      updateAddress();
      renderModeFields();
      // keep rate updated if value was cached by browser
      updateRateDisplay();
    });

    // optionally prevent paste/typing below min on blur
    usdtEl.addEventListener('blur', ()=>{
      const mode = paymentModeEl.value;
      const minAllowed = (mode === 'CDM') ? MIN_CDM : MIN_DEFAULT;
      const v = parseFloat(usdtEl.value);
      if(!isNaN(v) && v < minAllowed) usdtEl.value = '';
      updateRateDisplay();
    });

    // accessibility: enter key on copy button
    copyBtn.addEventListener('keydown',
