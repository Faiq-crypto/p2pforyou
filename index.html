<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P2Pforyou — Sell USDT</title>
  <meta name="description" content="Sell USDT — fast P2P orders. Select network, payment mode and submit order to merchant." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#04060a; --bg-2:#071426; --muted:#98a3b3; --accent:#00ff88; --accent-2:#33ffd4;
      --glass:rgba(255,255,255,0.03); --card: rgba(255,255,255,0.02); --radius:14px; --card-radius:12px;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;
      background: linear-gradient(135deg,var(--bg-1),var(--bg-2)); color:#e8f7f0;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .wrap{width:100%;max-width:900px}
    .panel{background:linear-gradient(180deg,var(--card),transparent); border-radius:var(--radius); padding:18px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 14px 50px rgba(2,8,23,0.6)}

    header{display:flex;gap:14px;align-items:center}
    .badge{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#001; padding:8px 12px; border-radius:10px; font-weight:800}
    h1{margin:0;font-size:18px}
    .lead{margin-top:6px;color:var(--muted);font-size:13px}

    .layout{display:grid;grid-template-columns:1fr 340px;gap:18px;margin-top:14px}
    @media(max-width:980px){ .layout{grid-template-columns:1fr} }

    /* Swap card */
    .swap{display:grid;gap:12px}
    .box{background:rgba(0,0,0,0.24); border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.02)}
    .label{color:var(--muted);font-size:13px;margin-bottom:8px}
    .box-row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .big{font-size:34px;color:#e6eef1;font-weight:700}
    .small{color:var(--muted);font-size:13px}

    /* network select with icons */
    .token-select{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.02)}
    .token-icon{width:30px;height:30px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;background:#061412;color:var(--accent);font-weight:700}
    select.input, input.input{background:transparent;border:none;color:inherit;font-size:14px;outline:none;width:100%}

    /* divider */
    .swap-divider{display:flex;align-items:center;justify-content:center;margin:6px 0}
    .arrow{width:46px;height:46px;border-radius:12px;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03)}

    /* modes */
    .modes{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .mode{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);font-weight:600}
    .mode.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#001;box-shadow:0 10px 30px rgba(0,255,136,0.06)}

    /* form fields */
    .input{width:100%;padding:12px 14px;border-radius:10px;background:rgba(0,0,0,0.24);border:1px solid rgba(255,255,255,0.03);color:inherit;font-size:14px}
    .input:focus{box-shadow:0 10px 30px rgba(0,255,136,0.04);transform:translateY(-1px);border-color:rgba(0,255,136,0.08)}

    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#001;border:none;font-weight:700}

    .rates{background:linear-gradient(180deg, rgba(255,255,255,0.012), transparent);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02)}
    .rate-card{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);margin-bottom:8px;border:1px solid rgba(255,255,255,0.02)}
    .range{color:var(--muted)}
    .value{color:var(--accent);font-weight:800}

    .note{color:var(--muted);font-size:13px;margin-top:6px}
    .error{color:#ff7b88;font-weight:700;margin-top:8px}

    /* modal */
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:60;opacity:0;pointer-events:none;transition:opacity .18s ease}
    .modal-backdrop.show{opacity:1;pointer-events:auto}
    .modal{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;padding:18px;max-width:520px;width:92%;border:1px solid rgba(255,255,255,0.03)}
    .modal h3{margin:0 0 8px 0}
    .modal .row{display:flex;justify-content:space-between;gap:8px;margin-top:8px}
    .thumb{max-width:80px;max-height:80px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);object-fit:cover}

    @media(max-width:520px){ .big{font-size:28px} .layout{grid-template-columns:1fr} .rates{order:-1;margin-bottom:12px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" role="main" aria-labelledby="pageTitle">
      <header>
        <div class="badge">P2Pforyou</div>
        <div>
          <h1 id="pageTitle">Sell USDT</h1>
          <div class="lead">Swap-style UI — enter USDT amount & select network. Address will appear after order submission.</div>
        </div>
      </header>

      <div class="layout">
        <!-- left: swap & controls -->
        <div>
          <div class="swap">
            <!-- From -->
            <div class="box">
              <div class="label">Sell</div>
              <div class="box-row">
                <div style="width:60%;">
                  <div class="big" id="usdtDisplay">0</div>
                  <div class="small" id="usdEq">₹0</div>
                </div>
                <div style="width:38%;">
                  <div class="token-select" title="Select network">
                    <div class="token-icon" id="tokenIcon">₮</div>
                    <select id="network" class="input" aria-label="Select network">
                      <option value="BEP20">USDT BEP20</option>
                      <option value="Polygon">USDT Polygon</option>
                      <option value="TRC20">USDT TRC20</option>
                    </select>
                  </div>
                </div>
              </div>
              <div style="margin-top:12px">
                <input id="usdt" class="input" type="number" inputmode="decimal" min="1.2" max="500" step="0.01" placeholder="Enter USDT amount" aria-label="USDT amount">
              </div>
            </div>

            <div class="swap-divider" aria-hidden="true">
              <div class="arrow">↓</div>
            </div>

            <!-- To -->
            <div class="box">
              <div class="label">Receive</div>
              <div class="box-row">
                <div style="width:60%;">
                  <div class="big" id="inrDisplay">₹0</div>
                  <div class="small">INR (fixed)</div>
                </div>
                <div style="width:38%;">
                  <div class="token-select" title="INR">
                    <div class="token-icon" style="background:#0b0b10;color:#fff">₹</div>
                    <div style="font-weight:700;padding-left:8px">INR</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- payment mode + dynamic fields -->
          <div style="margin-top:12px">
            <div class="label">Payment receiving mode</div>
            <div class="modes" role="radiogroup" aria-label="Payment mode">
              <button type="button" class="mode" data-mode="UPI" title="UPI"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M4 12v6a2 2 0 0 0 2 2h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg> UPI</button>
              <button type="button" class="mode" data-mode="Bank" title="Bank"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 10h18" stroke="currentColor" stroke-width="1.6"/><path d="M21 10l-9-6-9 6" stroke="currentColor" stroke-width="1.6"/></svg> Bank</button>
              <button type="button" class="mode" data-mode="CDM" title="CDM"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.6"/><path d="M8 8h8" stroke="currentColor" stroke-width="1.6"/></svg> CDM</button>
            </div>
            <div class="note" id="minNote">Minimum: <strong id="minValue">1.2</strong> USDT · Maximum: <strong>500</strong> USDT</div>
          </div>

          <form id="orderForm" style="margin-top:12px" autocomplete="off" novalidate>
            <!-- hidden fields to keep backend naming -->
            <input type="hidden" name="network" id="network_hidden">
            <input type="hidden" name="usdt_amount" id="usdt_hidden">
            <input type="hidden" name="usdt_address" id="usdt_address_hidden">
            <input type="hidden" name="payment_mode" id="payment_mode_hidden">

            <div id="modeFields" style="margin-top:8px"></div>

            <div class="actions">
              <button type="button" id="previewBtn" class="btn">Preview</button>
              <button type="submit" id="submitBtn" class="btn primary">Submit Order</button>
            </div>

            <div id="formError" role="status" aria-live="polite"></div>
          </form>
        </div>

        <!-- right: rates -->
        <aside class="rates" aria-hidden="false">
          <div class="rates-inner">
            <div class="rate-card"><div class="range">1.2 – 10 USDT</div><div class="value">₹83.50</div></div>
            <div class="rate-card"><div class="range">10.01 – 30.99 USDT</div><div class="value">₹84.00</div></div>
            <div class="rate-card"><div class="range">30.99 – 100.99 USDT</div><div class="value">₹85.20</div></div>
            <div class="rate-card"><div class="range">100.99 – 380.90 USDT</div><div class="value">₹86.00</div></div>
            <div class="rate-card"><div class="range">380.90 – 500 USDT</div><div class="value">₹86.60</div></div>
            <div style="margin-top:8px" class="note">Rates shown for quick reference. Final rate calculated when you submit order.</div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div class="watermark">P2Pforyou</div>

  <!-- CONFIRMATION MODAL -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Confirm your order</h3>
      <div id="modalContent" style="margin-top:8px">
        <!-- filled dynamically -->
      </div>
      <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalConfirm" class="btn primary">Confirm & Submit</button>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // KEEP BACKEND URL UNCHANGED
    // -------------------------
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxuTvGuI7VGakfHIXOip8yDy261HUo4ycW0FPqJNo1nVTteLAEbavONXtbAPEvKbXWE/exec';

    // Elements
    const usdtInput = document.getElementById('usdt');
    const usdtDisplay = document.getElementById('usdtDisplay');
    const usdEq = document.getElementById('usdEq');
    const inrDisplayBig = document.getElementById('inrDisplay');
    const networkSelect = document.getElementById('network');
    const networkHidden = document.getElementById('network_hidden');
    const usdtHidden = document.getElementById('usdt_hidden');
    const usdtAddressHidden = document.getElementById('usdt_address_hidden');
    const paymentModeHidden = document.getElementById('payment_mode_hidden');
    const modes = document.querySelectorAll('.mode');
    const modeFieldsContainer = document.getElementById('modeFields');
    const minValueEl = document.getElementById('minValue');
    const minNote = document.getElementById('minNote');
    const formError = document.getElementById('formError');
    const previewBtn = document.getElementById('previewBtn');
    const submitBtn = document.getElementById('submitBtn');
    const orderForm = document.getElementById('orderForm');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContent = document.getElementById('modalContent');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');
    const tokenIcon = document.getElementById('tokenIcon');

    // Addresses
    const addresses = {
      BEP20: '0x1A63d865D881E15D4103a5c031a67C0d63e9849C',
      Polygon: '0x1A63d865D881E15D4103a5c031a67C0d63e9849C',
      TRC20: 'TUYMmZN5oTfyjDZ8zqbqsfepdbvBgoBDz3'
    };

    // rates
    function getRate(amount){
      if(amount >= 1.2 && amount <= 10) return 83.5;
      if(amount > 10 && amount <= 30.99) return 84;
      if(amount > 30.99 && amount <= 100.99) return 85.2;
      if(amount > 100.99 && amount <= 380.9) return 86;
      if(amount > 380.9 && amount <= 500) return 86.6;
      return 0;
    }

    const MIN_DEFAULT = 1.2;
    const MIN_CDM = 50;
    let activeMode = null;

    // initialize hidden fields
    function initNetwork(){
      networkHidden.value = networkSelect.value;
      usdtAddressHidden.value = addresses[networkSelect.value] || addresses.BEP20;
      // show small icon letter for TRC vs ETH-like networks
      tokenIcon.textContent = (networkSelect.value === 'TRC20') ? 'T' : '₮';
    }
    networkSelect.addEventListener('change', initNetwork);
    initNetwork();

    // modes behavior
    modes.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        modes.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        activeMode = btn.dataset.mode;
        paymentModeHidden.value = activeMode;
        renderModeFields(activeMode);
      });
      btn.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); btn.click(); } });
    });

    // render dynamic inputs per mode and set min
    function renderModeFields(mode){
      modeFieldsContainer.innerHTML = ''; formError.textContent = '';
      let minAllowed = MIN_DEFAULT;
      if(mode === 'UPI'){
        minAllowed = MIN_DEFAULT;
        modeFieldsContainer.innerHTML = `
          <label class="label">UPI ID</label>
          <input name="upi_id" class="input" placeholder="yourupi@bank" />
          <label class="label">Upload Scanner (PNG)</label>
          <input name="scanner" id="scannerInput" class="input" type="file" accept="image/png" />
          <div id="scannerPreviewWrap" style="margin-top:8px"></div>
        `;
        attachScannerPreview();
      } else if(mode === 'Bank'){
        minAllowed = MIN_DEFAULT;
        modeFieldsContainer.innerHTML = `
          <label class="label">Bank Name</label><input name="bank_name" class="input" placeholder="Bank name" />
          <label class="label">Account Number</label><input name="bank_account_number" class="input" placeholder="Account number" />
          <label class="label">Account Holder</label><input name="bank_holder_name" class="input" placeholder="Account holder" />
          <label class="label">IFSC</label><input name="ifsc_code" class="input" placeholder="IFSC code" />
        `;
      } else if(mode === 'CDM'){
        minAllowed = MIN_CDM;
        modeFieldsContainer.innerHTML = `
          <label class="label">Account Number</label><input name="cdm_account_number" class="input" placeholder="Account number" />
          <label class="label">Bank Name</label><input name="cdm_bank_name" class="input" placeholder="Bank name" />
          <label class="label">Account Holder</label><input name="cdm_holder_name" class="input" placeholder="Account holder" />
          <div class="note">CDM orders start from <strong>50 USDT</strong>.</div>
        `;
      } else {
        modeFieldsContainer.innerHTML = `<div class="note">Choose a payment mode</div>`;
      }

      minValueEl.textContent = Number(minAllowed).toFixed(2).replace(/\.00$/,'');
      minNote.textContent = `Minimum: ${minValueEl.textContent} USDT · Maximum: 500 USDT`;
      usdtInput.min = minAllowed;
      usdtInput.placeholder = `Min ${usdtInput.min} · Max 500`;
      updateDisplays();
    }

    // attach scanner preview logic
    function attachScannerPreview(){
      const scanner = document.getElementById('scannerInput');
      if(!scanner) return;
      const wrap = document.getElementById('scannerPreviewWrap');
      wrap.innerHTML = '';
      scanner.addEventListener('change', ()=>{
        wrap.innerHTML = '';
        const f = scanner.files[0];
        if(!f) return;
        if(!f.name.toLowerCase().endsWith('.png') && f.type !== 'image/png'){
          wrap.innerHTML = `<div class="error">Scanner must be a PNG file.</div>`;
          scanner.value = '';
          return;
        }
        if(f.size > 5 * 1024 * 1024){
          const ok = confirm('Scanner file is larger than 5MB. Continue?');
          if(!ok){ scanner.value = ''; return; }
        }
        const img = document.createElement('img');
        img.className = 'thumb';
        img.alt = 'Scanner preview';
        const url = URL.createObjectURL(f);
        img.src = url;
        wrap.appendChild(img);
      });
    }

    // update displays (amount, INR)
    function updateDisplays(){
      const vRaw = parseFloat(usdtInput.value);
      const v = isNaN(vRaw) ? 0 : vRaw;
      if(v <= 0){
        usdtDisplay.textContent = '0';
        usdEq.textContent = '₹0';
        inrDisplayBig.textContent = '₹0';
        formError.innerHTML = '';
        return;
      }
      const val = Math.min(500, v);
      const rate = getRate(val);
      const inr = rate ? (val * rate) : 0;
      usdtDisplay.textContent = Number(val).toFixed(2).replace(/\.00$/,'');
      usdEq.textContent = `≈ ₹${inr.toFixed(2)}`;
      inrDisplayBig.textContent = `₹${inr.toFixed(2)}`;
      const minAllowed = (activeMode === 'CDM') ? MIN_CDM : MIN_DEFAULT;
      if(val < minAllowed){
        formError.innerHTML = `<div class="error">Minimum for ${activeMode || 'selected mode'} is ${minAllowed} USDT.</div>`;
      } else {
        formError.innerHTML = '';
      }
      // keep hiddens updated
      networkHidden.value = networkSelect.value;
      usdtHidden.value = val;
      usdtAddressHidden.value = addresses[networkSelect.value] || addresses.BEP20;
      paymentModeHidden.value = activeMode || '';
    }
    usdtInput.addEventListener('input', updateDisplays);

    // show modal
    function openModal(contentHtml){
      modalContent.innerHTML = contentHtml;
      modalBackdrop.classList.add('show');
      modalBackdrop.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modalBackdrop.classList.remove('show');
      modalBackdrop.setAttribute('aria-hidden','true');
    }
    modalCancel.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) closeModal(); });

    // build modal content and open
    previewBtn.addEventListener('click', ()=>{
      const amount = parseFloat(usdtInput.value);
      if(!activeMode) return alert('Choose payment mode (UPI / Bank / CDM).');
      if(isNaN(amount) || amount <= 0) return alert('Enter a valid USDT amount.');
      const minAllowed = (activeMod
